# 🏗️ IDA Pro MCP 架构说明

本文档详细解释 IDA Pro MCP 的各种部署架构和工作原理。

---

## 📊 架构总览

### 1️⃣ 本地模式（默认）

```
┌─────────────────────────────────────────────────────────┐
│ 本地计算机                                                 │
│                                                           │
│  ┌──────────────┐    stdio     ┌──────────────────────┐ │
│  │ MCP 客户端   │ ◄──────────► │   server.py          │ │
│  │ (Claude/Cline)│              │   (代理进程)          │ │
│  └──────────────┘              └──────────────────────┘ │
│                                          │               │
│                                          │ HTTP          │
│                                          ▼               │
│  ┌──────────────┐              ┌──────────────────────┐ │
│  │  IDA Pro     │              │  IDA 插件             │ │
│  │  (GUI)       │ ◄────────────│  (127.0.0.1:13337)  │ │
│  └──────────────┘              └──────────────────────┘ │
│                                                           │
└─────────────────────────────────────────────────────────┘

特点：
✅ 简单易用，无需额外配置
✅ 完整功能支持（包括调试器）
❌ 仅限本地访问
```

---

### 2️⃣ 云服务器模式（新增支持）

#### 方案 A: 直接部署 IDA 插件

```
┌─────────────────────────────────────────────────────────┐
│ 云服务器 (例如: AWS, 阿里云, 腾讯云)                        │
│                                                           │
│  ┌──────────────┐              ┌──────────────────────┐ │
│  │  IDA Pro     │              │  IDA 插件             │ │
│  │  (GUI/VNC)   │ ◄────────────│  (0.0.0.0:13337)    │ │
│  └──────────────┘              └──────────────────────┘ │
│                                          │               │
│                                          │ HTTP/SSE      │
└──────────────────────────────────────────┼───────────────┘
                                           │
                          通过公网或 VPN 访问
                                           │
┌──────────────────────────────────────────┼───────────────┐
│ 本地计算机                                 │               │
│                                           ▼               │
│  ┌──────────────┐    HTTP/SSE  ┌──────────────────────┐ │
│  │ MCP 客户端   │ ◄──────────► │  认证 Token 验证      │ │
│  │ (curl/Python)│              │  Authorization: Bearer│ │
│  └──────────────┘              └──────────────────────┘ │
└─────────────────────────────────────────────────────────┘

配置：
export IDA_MCP_HOST="0.0.0.0"
export IDA_MCP_AUTH_TOKEN="your-token"

特点：
✅ 完整 IDA 功能
✅ 支持调试器
✅ 直连性能好
❌ 需要 X11/VNC
⚠️ 必须配置认证
```

#### 方案 B: 无头模式 (idalib)

```
┌─────────────────────────────────────────────────────────┐
│ 云服务器                                                   │
│                                                           │
│  ┌──────────────────────────────────────────────────────┐│
│  │ idalib-mcp                                            ││
│  │ - 无 GUI，自动分析                                     ││
│  │ - 监听 0.0.0.0:8745                                   ││
│  │ - 内置认证                                             ││
│  └──────────────────────────────────────────────────────┘│
│                                          │               │
└──────────────────────────────────────────┼───────────────┘
                                           │
                                           │ HTTP/SSE
                                           │
┌──────────────────────────────────────────┼───────────────┐
│ 本地计算机                                 ▼               │
│  ┌──────────────────────────────────────────────────┐   │
│  │ MCP 客户端 (带认证)                               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

启动：
uv run idalib-mcp --host 0.0.0.0 --auth-token "token" binary.exe

特点：
✅ 资源占用低
✅ 无需 GUI
✅ 适合批量分析
❌ 不支持调试器
❌ 需要 IDA Pro 9.0+
```

#### 方案 C: 代理模式

```
┌─────────────────────────────────────────────────────────┐
│ 云服务器                                                   │
│                                                           │
│  ┌──────────────┐              ┌──────────────────────┐ │
│  │  IDA Pro     │              │  IDA 插件             │ │
│  │  (VNC)       │ ◄────────────│  (127.0.0.1:13337)  │ │
│  └──────────────┘              └──────────────────────┘ │
│                                          │               │
│                                          │ HTTP (本地)   │
│                                          ▼               │
│                                ┌──────────────────────┐ │
│                                │  server.py 代理       │ │
│                                │  - 监听 0.0.0.0:8744  │ │
│                                │  - 添加认证层         │ │
│                                │  - 转发到 IDA         │ │
│                                └──────────────────────┘ │
│                                          │               │
└──────────────────────────────────────────┼───────────────┘
                                           │ HTTP/SSE
                                           │
┌──────────────────────────────────────────┼───────────────┐
│ 本地计算机                                 ▼               │
│  ┌──────────────────────────────────────────────────┐   │
│  │ MCP 客户端 (带认证)                               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

启动：
# 1. IDA 插件正常启动 (127.0.0.1:13337)
# 2. 代理服务器
uv run ida-pro-mcp --transport http://0.0.0.0:8744/sse \
    --auth-token "token"

特点：
✅ 灵活，可添加额外功能
✅ 支持多客户端
✅ 易于集成反向代理
❌ 需要两个进程
❌ 额外的网络跳转
```

---

## 🔐 安全架构

### 基础认证层

```
                    ┌─────────────────────┐
客户端请求 ────────►│  检查 Authorization  │
Authorization:      │  Bearer token        │
Bearer xxx          └─────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                  ✅ 正确              ❌ 错误
                    │                   │
              ┌─────▼─────┐       ┌────▼────┐
              │ 200 OK    │       │ 403     │
              │ 处理请求   │       │ Forbidden│
              └───────────┘       └─────────┘
```

### 多层安全架构（生产推荐）

```
┌─────────────────────────────────────────────────────────┐
│ 第 1 层: 网络层安全                                        │
│  - 防火墙 (ufw/firewalld)                                │
│  - 云服务商安全组                                          │
│  - VPN/SSH 隧道                                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ 第 2 层: TLS 加密 (可选)                                   │
│  - nginx 反向代理                                          │
│  - Let's Encrypt 证书                                     │
│  - HTTP → HTTPS                                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ 第 3 层: HTTP 认证 (可选)                                  │
│  - nginx Basic Auth                                       │
│  - htpasswd 用户名/密码                                    │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ 第 4 层: MCP 认证 (必需)                                   │
│  - Authorization Header                                   │
│  - Bearer Token 验证                                      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ IDA Pro MCP Server                                       │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 通信协议

### HTTP 传输模式

```
客户端                                服务器
  │                                    │
  │  POST /mcp                         │
  │  Content-Type: application/json    │
  │  Authorization: Bearer token       │
  │  {jsonrpc: "2.0", method: ...}     │
  │─────────────────────────────────►  │
  │                                    │
  │                                    │ 验证 Token
  │                                    │ 处理请求
  │                                    │
  │  200 OK                            │
  │  {jsonrpc: "2.0", result: ...}     │
  │ ◄─────────────────────────────────│
  │                                    │
```

### SSE 传输模式

```
客户端                                服务器
  │                                    │
  │  GET /sse                          │
  │  Authorization: Bearer token       │
  │─────────────────────────────────►  │
  │                                    │
  │  200 OK                            │
  │  Content-Type: text/event-stream   │
  │  Connection: keep-alive            │
  │ ◄─────────────────────────────────│
  │                                    │
  │  event: endpoint                   │
  │  data: /sse?session=uuid           │
  │ ◄─────────────────────────────────│
  │                                    │
  │  event: ping                       │
  │  data: {}                          │
  │ ◄─────────────────────────────────│ (每 30 秒)
  │                                    │
  │  POST /sse?session=uuid            │
  │  {jsonrpc: "2.0", method: ...}     │
  │─────────────────────────────────►  │
  │                                    │
  │  202 Accepted                      │
  │ ◄─────────────────────────────────│
  │                                    │
  │  event: message                    │
  │  data: {jsonrpc: "2.0", result:...}│
  │ ◄─────────────────────────────────│
  │                                    │
```

---

## 📦 数据流

### 反编译请求示例

```
┌─────────────┐
│ MCP 客户端  │
└──────┬──────┘
       │
       │ tools/call {name: "decompile", args: {addrs: "0x401000"}}
       ▼
┌─────────────┐
│ MCP Server  │
│ (HTTP/SSE)  │
└──────┬──────┘
       │
       │ dispatch_proxy()
       ▼
┌─────────────┐
│ IDA 插件    │
│ (JSON-RPC)  │
└──────┬──────┘
       │
       │ @idaread 装饰器 → 主线程
       ▼
┌─────────────┐
│ api_analysis│
│ .decompile()│
└──────┬──────┘
       │
       │ ida_hexrays.decompile_func()
       ▼
┌─────────────┐
│ IDA SDK     │
│ Hex-Rays    │
└──────┬──────┘
       │
       │ 反编译结果
       ▼
┌─────────────┐
│ 返回给客户端 │
└─────────────┘
```

---

## 🔧 线程模型

### IDA 插件内部

```
┌─────────────────────────────────────────────────────────┐
│ IDA Pro 进程                                              │
│                                                           │
│  ┌──────────────┐        ┌──────────────────────────┐   │
│  │ IDA 主线程   │        │ HTTP 服务器线程           │   │
│  │ - GUI 更新   │◄───────│ - 接收请求               │   │
│  │ - SDK 调用   │ execute│ - 验证认证               │   │
│  │ - 数据库修改 │  _sync │ - 排队任务               │   │
│  └──────────────┘        └──────────────────────────┘   │
│         ▲                          │                     │
│         │                          │                     │
│         │ 结果                     │ 请求                │
│         │                          ▼                     │
│  ┌──────────────────────────────────────────────┐       │
│  │ 同步队列 (sync.py)                            │       │
│  │ - @idaread: 只读操作                          │       │
│  │ - @idawrite: 修改操作                         │       │
│  │ - 线程安全保证                                 │       │
│  └──────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

---

## 📈 性能考虑

### 延迟分析

```
┌──────────────┬─────────────┬──────────────┐
│ 组件         │ 延迟        │ 优化建议      │
├──────────────┼─────────────┼──────────────┤
│ 网络传输     │ 10-500ms    │ 就近部署      │
│ 认证验证     │ <1ms        │ Token 缓存    │
│ JSON 序列化  │ 1-10ms      │ 批量操作      │
│ IDA 主线程   │ 可变        │ 避免阻塞      │
│ 反编译       │ 100ms-10s   │ 缓存结果      │
└──────────────┴─────────────┴──────────────┘

总延迟 = 网络延迟 × 2 + 处理时间

优化策略：
1. 批量请求减少往返
2. 本地缓存常用数据
3. 使用 HTTP/2 多路复用
4. 压缩响应数据 (gzip)
```

---

## 🎯 选择建议

### 使用场景决策树

```
需要云端分析？
  ├─ 否 ────────────────────────► 使用本地模式
  │
  └─ 是 ──► 需要调试器？
             ├─ 是 ──► 有 GUI 环境？
             │         ├─ 是 ────► 方案 A (IDA 插件)
             │         └─ 否 ────► 考虑 VNC/X11
             │
             └─ 否 ──► 纯分析任务？
                       ├─ 是 ────► 方案 B (idalib)
                       └─ 否 ────► 方案 C (代理模式)
```

### 功能对比表

| 功能           | 本地模式 | 云-IDA插件 | 云-idalib | 云-代理 |
|----------------|---------|-----------|----------|---------|
| 反编译         | ✅      | ✅        | ✅       | ✅      |
| 调试器         | ✅      | ✅        | ❌       | ✅      |
| 远程访问       | ❌      | ✅        | ✅       | ✅      |
| 无需 GUI       | ❌      | ❌        | ✅       | ❌      |
| 认证支持       | 可选    | 必需      | 必需     | 必需    |
| 资源占用       | 中      | 中        | 低       | 高      |
| 配置复杂度     | 低      | 中        | 低       | 高      |

---

## 🔗 相关文档

- [DEPLOYMENT.md](DEPLOYMENT.md) - 详细部署指南
- [AUTHENTICATION.md](AUTHENTICATION.md) - 认证配置
- [README.md](README.md) - 项目主文档
- [CLAUDE.md](CLAUDE.md) - 开发指南
